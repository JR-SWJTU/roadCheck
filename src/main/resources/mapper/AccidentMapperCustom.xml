<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.swjtu.roadCheck.mapper.AccidentMapperCustom">


    <!--多重搜索条件下某路段发生的事故数量搜索-->
    <select id="multiConditionQueryAccidentForSGS" parameterType="com.swjtu.roadCheck.entityCustom.AccidentQueryCondition"
            resultType="com.swjtu.roadCheck.dto.Accident">

        SELECT
        count(*) AS num,diMingBeiZhu
        FROM

        (
        SELECT
        *
        FROM
        <if test="roadLevel!=null || weather!=null || workPlaceRel != null || intersectionType != null">
            (
            SELECT
            *
            FROM
            (
            SELECT
            e.emnumber
            FROM
            emdata e
            <where>
                <if test="roadLevel!=null">
                    e.luMianLev = #{roadLevel}
                </if>
                <if test="weather!=null">
                    AND e.Tianqicondition = #{weather}
                </if>
                <if test="workPlaceRel != null">
                    AND e.workPlaceRel = #{workPlaceRel}
                </if>
                <if test="intersectionType != null">
                    AND e.Jcktype = #{intersectionType}
                </if>
            </where>
            ) eResult INNER JOIN
        </if>

        <if test="teamName!=null || startTime!=null || endTime!=null">
            (
            SELECT
            *
            FROM
            accidencecollectiondata
            <where>
                <if test="teamName!=null">
                    team_name = #{teanName}
                </if>
                <if test="startTime!=null">
                    AND riqi <![CDATA[ >= ]]> #{startTime}
                </if>
                <if test="endTime!=null">
                    AND riqi <![CDATA[ <= ]]> #{endTime}
                </if>
            </where>
            ) acd
        </if>


        <if test="roadLevel!=null || weather!=null || workPlaceRel != null || intersectionType != null">
            ON eResult.emnumber = acd.environmentnumber
            ) acdResult
        </if>


        <if test="teamName!=null || startTime!=null || endTime!=null">
            INNER JOIN
        </if>

        (
        SELECT
        accidencnumber,
        diMingBeiZhu
        FROM
        accidentdata
        <where>
            <if test="carCollisionType!=null">
                accidentdata.shiguType = #{carCollisionType}
            </if>
            <if test="troEscape!=null">
                AND accidentdata.taoYi = #{troEscape}
            </if>
            <if test="areaName!=null">
                AND accidentdata.xianQu = #{areaName}
            </if>
            <if test="isWorkDay!=null">
                AND accidentdata.is_workday = #{isWorkDay}
            </if>
        </where>
        ) aResult

        <if test="teamName!=null || startTime!=null || endTime!=null">
            ON acdResult.shigunumber = aResult.accidencnumber
            ) res1
        </if>

        <if test="carType!= null">
            INNER JOIN (
            SELECT
            carnumber
            FROM
            cardata
            <where>
                <if test="carType!= null">
                    Leixing = #{carType}
                </if>
            </where>
            ) carResult ON res1.carnumber = carResult.carnumber
        </if>
        GROUP BY diMingBeiZhu
    </select>



    <!--事故分析中的空间分析，多重搜索条件下某路段发生的不同事故严重程度的事故的统计-->
    <select id="multiConditionQueryAccidentForYZCD" parameterType="com.swjtu.roadCheck.entityCustom.AccidentQueryCondition"
            resultType="com.swjtu.roadCheck.dto.Accident">

        SELECT
        count(*) as num,diMingBeiZhu,yanZhongCd
        FROM

        (
        SELECT
        *
        FROM
        <if test="roadLevel!=null || weather!=null || workPlaceRel != null || intersectionType != null">
            (
            SELECT
            *
            FROM
            (
            SELECT
            e.emnumber
            FROM
            emdata e
            <where>
                <if test="roadLevel!=null">
                    e.luMianLev = #{roadLevel}
                </if>
                <if test="weather!=null">
                    AND e.Tianqicondition = #{weather}
                </if>
                <if test="workPlaceRel != null">
                    AND e.workPlaceRel = #{workPlaceRel}
                </if>
                <if test="intersectionType != null">
                    AND e.Jcktype = #{intersectionType}
                </if>
            </where>
            ) eResult INNER JOIN
        </if>

        <if test="teamName!=null || startTime!=null || endTime!=null">
            (
            SELECT
            *
            FROM
            accidencecollectiondata
            <where>
                <if test="teamName!=null">
                    team_name = #{teanName}
                </if>
                <if test="startTime!=null">
                    AND riqi <![CDATA[ >= ]]> #{startTime}
                </if>
                <if test="endTime!=null">
                    AND riqi <![CDATA[ <= ]]> #{endTime}
                </if>
            </where>
            ) acd
        </if>


        <if test="roadLevel!=null || weather!=null || workPlaceRel != null || intersectionType != null">
            ON eResult.emnumber = acd.environmentnumber
            ) acdResult
        </if>


        <if test="teamName!=null || startTime!=null || endTime!=null">
            INNER JOIN
        </if>

        (
        SELECT
        accidencnumber,
        diMingBeiZhu,
        yanZhongCd
        FROM
        accidentdata
        <where>
            <if test="carCollisionType!=null">
                accidentdata.shiguType = #{carCollisionType}
            </if>
            <if test="troEscape!=null">
                AND accidentdata.taoYi = #{troEscape}
            </if>
            <if test="areaName!=null">
                AND accidentdata.xianQu = #{areaName}
            </if>
            <if test="isWorkDay!=null">
                AND accidentdata.is_workday = #{isWorkDay}
            </if>
        </where>
        ) aResult

        <if test="teamName!=null || startTime!=null || endTime!=null">
            ON acdResult.shigunumber = aResult.accidencnumber
            ) res1
        </if>

        <if test="carType!= null">
            INNER JOIN (
            SELECT
            carnumber
            FROM
            cardata
            <where>
                <if test="carType!= null">
                    Leixing = #{carType}
                </if>
            </where>
            ) carResult ON res1.carnumber = carResult.carnumber
        </if>
        GROUP BY diMingBeiZhu,yanZhongCd
    </select>


    <!--事故分析中的时间分析，多重搜索条件下某路段发生的不同事故严重程度的事故的统计或者事故数量统计，按照年月日进行统计-->
    <select id="multiConditionQueryAccidentForTime" parameterType="com.swjtu.roadCheck.entityCustom.AccidentQueryCondition"
            resultType="com.swjtu.roadCheck.dto.Accident">

        SELECT
        count(*) as num,diMingBeiZhu
        <if test="yType==false">
            ,yanZhongCd
        </if>
        <if test="timePrecision==null || timePrecision>=1">
            ,YEAR (riqi) AS year
        </if>
        <if test="timePrecision>=2">
            ,MONTH (riqi) as month
        </if>
        <if test="timePrecision>=3">
            ,DAY(riqi) as day
        </if>
        FROM

        (
        SELECT
        *
        FROM
        <if test="roadLevel!=null || weather!=null || workPlaceRel != null || intersectionType != null">
            (
            SELECT
            *
            FROM
            (
            SELECT
            e.emnumber
            FROM
            emdata e
            <where>
                <if test="roadLevel!=null">
                    e.luMianLev = #{roadLevel}
                </if>
                <if test="weather!=null">
                    AND e.Tianqicondition = #{weather}
                </if>
                <if test="workPlaceRel != null">
                    AND e.workPlaceRel = #{workPlaceRel}
                </if>
                <if test="intersectionType != null">
                    AND e.Jcktype = #{intersectionType}
                </if>
            </where>
            ) eResult INNER JOIN
        </if>

        <if test="teamName!=null || startTime!=null || endTime!=null">
            (
            SELECT
            *
            FROM
            accidencecollectiondata
            <where>
                <if test="teamName!=null">
                    team_name = #{teanName}
                </if>
                <if test="startTime!=null">
                    AND riqi <![CDATA[ >= ]]> #{startTime}
                </if>
                <if test="endTime!=null">
                    AND riqi <![CDATA[ <= ]]> #{endTime}
                </if>
            </where>
            ) acd
        </if>


        <if test="roadLevel!=null || weather!=null || workPlaceRel != null || intersectionType != null">
            ON eResult.emnumber = acd.environmentnumber
            ) acdResult
        </if>


        <if test="teamName!=null || startTime!=null || endTime!=null">
            INNER JOIN
        </if>

        (
        SELECT
        accidencnumber,
        diMingBeiZhu,
        yanZhongCd
        FROM
        accidentdata
        <where>
            <if test="carCollisionType!=null">
                accidentdata.shiguType = #{carCollisionType}
            </if>
            <if test="troEscape!=null">
                AND accidentdata.taoYi = #{troEscape}
            </if>
            <if test="areaName!=null">
                AND accidentdata.xianQu = #{areaName}
            </if>
            <if test="isWorkDay!=null">
                AND accidentdata.is_workday = #{isWorkDay}
            </if>
        </where>
        ) aResult

        <if test="teamName!=null || startTime!=null || endTime!=null">
            ON acdResult.shigunumber = aResult.accidencnumber
            ) res1
        </if>

        <if test="carType!= null">
            INNER JOIN (
            SELECT
            carnumber
            FROM
            cardata
            <where>
                <if test="carType!= null">
                    Leixing = #{carType}
                </if>
            </where>
            ) carResult ON res1.carnumber = carResult.carnumber
        </if>

        GROUP BY diMingBeiZhu
        <if test="yType==false">
        ,yanZhongCd
        </if>
        <if test="timePrecision==null || timePrecision>=1">
            ,YEAR (riqi)
        </if>
        <if test="timePrecision>=2">
            ,MONTH (riqi)
        </if>
        <if test="timePrecision>=3">
            ,DAY(riqi)
        </if>

    </select>


</mapper>